#define BOOST_TEST_MODULE rdkit_extensions_cg_coordgen

#include <boost/test/data/test_case.hpp>
#include <boost/test/unit_test.hpp>
#include <rdkit/GraphMol/RWMol.h>

#include <vector>
#include <string>

#include "schrodinger/rdkit_extensions/helm.h"
#include "schrodinger/rdkit_extensions/helm/to_rdkit.h"

using helm::helm_to_rdkit;
using schrodinger::rdkit_extensions::compute_monomer_mol_coords;

namespace bdata = boost::unit_test::data;

typedef std::vector<std::vector<double>> coords_t;
BOOST_TEST_DONT_PRINT_LOG_VALUE(coords_t)
typedef std::pair<std::string, coords_t> mol_data_t;
BOOST_TEST_DONT_PRINT_LOG_VALUE(mol_data_t)

BOOST_DATA_TEST_CASE(
    TestComputeCGCoords,
    bdata::make(std::vector<mol_data_t>{
        // Linear polymers
        {"RNA1{R(U)P.R(T)P.R(G)P.R(C)P.R(A)}$$$$",
         {{0, 0},
          {0, -1.5},
          {1.5, 0},
          {3, 0},
          {3, -1.5},
          {4.5, 0},
          {6, 0},
          {6, -1.5},
          {7.5, 0},
          {9, 0},
          {9, -1.5},
          {10.5, 0},
          {12, 0},
          {12, -1.5}}},

        {"PEPTIDE1{D.E.F.G}|PEPTIDE2{C.E}$PEPTIDE1,PEPTIDE2,2:R3-1:R1$$$V2.0",
         {{0, 0}, {1.5, 0}, {3, 0}, {4.5, 0}, {1.5, -1.5}, {3, -1.5}}},

        {"RNA1{R(A)P.R(G)P.R(C)P.R(U)P.R(C)P.R(C)P.R(C)}|RNA2{R(U)P.R(G)P.R("
         "G)P.R(G)P.R(G)P.R(A)P.R(G)}$RNA1,RNA2,17:pair-11:pair|RNA1,RNA2,"
         "20:pair-8:pair|RNA1,RNA2,14:pair-14:pair|RNA1,RNA2,11:pair-17:"
         "pair|RNA1,RNA2,8:pair-20:pair$$$",
         {{0, 0},       {0, -1.5},    {1.5, 0},     {3, 0},       {3, -1.5},
          {4.5, 0},     {6, 0},       {6, -1.5},    {7.5, 0},     {9, 0},
          {9, -1.5},    {10.5, 0},    {12, 0},      {12, -1.5},   {13.5, 0},
          {15, 0},      {15, -1.5},   {16.5, 0},    {18, 0},      {18, -1.5},
          {24, -4.5},   {24, -3},     {22.5, -4.5}, {21, -4.5},   {21, -3},
          {19.5, -4.5}, {18, -4.5},   {18, -3},     {16.5, -4.5}, {15, -4.5},
          {15, -3},     {13.5, -4.5}, {12, -4.5},   {12, -3},     {10.5, -4.5},
          {9, -4.5},    {9, -3},      {7.5, -4.5},  {6, -4.5},    {6, -3}}},

        {"PEPTIDE1{[Sar].[dR].[dC].[dY].[dC].[dH].[dP].[dF]}|PEPTIDE2{[Sar].["
         "dR].[dC].[dY].[dC].[dH].[dP].[dF]}$PEPTIDE1,PEPTIDE2,5:R3-3:R3|"
         "PEPTIDE1,PEPTIDE2,3:R3-5:R3$$$",
         {{0, 0},
          {1.5, 0},
          {3, 0},
          {4.5, 0},
          {6, 0},
          {7.5, 0},
          {9, 0},
          {10.5, 0},
          {3, -1.5},
          {4.5, -1.5},
          {6, -1.5},
          {7.5, -1.5},
          {9, -1.5},
          {10.5, -1.5},
          {12, -1.5},
          {13.5, -1.5}}},

        // Snaking linear polymers
        {"PEPTIDE1{K.W.L.N.A.L.L.H.H.G.L}$$$$V2.0",
         {{0, 0},
          {1.5, 0},
          {3, 0},
          {4.5, 0},
          {6, 0},
          {7.5, 0},
          {9, 0},
          {10.5, 0},
          {12, 0},
          {13.5, 0},
          {13.5, -1.5}}},

        {"PEPTIDE1{K.W.L.N.A.L.L.H.H.G.L.N.C.A.K.G.V.L.A.W.L.N.A.L.L.H}$$$$V2."
         "0",
         {{0, 0},       {1.5, 0},    {3, 0},       {4.5, 0},    {6, 0},
          {7.5, 0},     {9, 0},      {10.5, 0},    {12, 0},     {13.5, 0},
          {13.5, -1.5}, {12, -1.5},  {10.5, -1.5}, {9, -1.5},   {7.5, -1.5},
          {6, -1.5},    {4.5, -1.5}, {3, -1.5},    {1.5, -1.5}, {0, -1.5},
          {0, -3},      {1.5, -3},   {3, -3},      {4.5, -3},   {6, -3},
          {7.5, -3}}},

        // Double stranded nucleic acids
        {"RNA1{R(C).P.R(A).P.R(T).P}|RNA2{R(C).P.R(A).P.R(T).P}$RNA1,RNA2,1:R1-"
         "5:R1|RNA1,RNA2,5:R1-1:R1$$$V2.0",
         {{0, 0},
          {0, -1.5},
          {1.5, 0},
          {3, 0},
          {3, -1.5},
          {4.5, 0},
          {6, 0},
          {6, -1.5},
          {7.5, 0},
          {3, -4.5},
          {3, -3},
          {1.5, -4.5},
          {0, -4.5},
          {0, -3},
          {-1.5, -4.5},
          {-3, -4.5},
          {-3, -3},
          {-4.5, -4.5}}},

        {"PEPTIDE1{R.A.Y}|RNA1{r(G).p.r(A).p.r(U).p.r(C).p.[mR](U).p.[mR](U).p."
         "r(A).p}|RNA2{p.r(U).p.r(A).p.r(A).p.r(G).p.r(A).p.r(U).p.r(C).p.r(A)."
         "p.r(A)}$RNA1,RNA2,2:pair-21:pair|RNA1,RNA2,5:pair-18:pair|RNA1,RNA2,"
         "8:pair-15:pair|RNA1,RNA2,11:pair-12:pair|RNA1,RNA2,14:pair-9:pair|"
         "RNA1,RNA2,17:pair-6:pair|RNA1,RNA2,20:pair-3:pair|RNA1,PEPTIDE1,21:"
         "R2-1:R1$$$V2.0",
         {{0, 0},        {1.5, 0},      {3, 0},        {-19.5, -1.5},
          {-19.5, -3},   {-18, -1.5},   {-16.5, -1.5}, {-16.5, -3},
          {-15, -1.5},   {-13.5, -1.5}, {-13.5, -3},   {-12, -1.5},
          {-10.5, -1.5}, {-10.5, -3},   {-9, -1.5},    {-7.5, -1.5},
          {-7.5, -3},    {-6, -1.5},    {-4.5, -1.5},  {-4.5, -3},
          {-3, -1.5},    {-1.5, -1.5},  {-1.5, -3},    {0, -1.5},
          {0, -6},       {-1.5, -6},    {-1.5, -4.5},  {-3, -6},
          {-4.5, -6},    {-4.5, -4.5},  {-6, -6},      {-7.5, -6},
          {-7.5, -4.5},  {-9, -6},      {-10.5, -6},   {-10.5, -4.5},
          {-12, -6},     {-13.5, -6},   {-13.5, -4.5}, {-15, -6},
          {-16.5, -6},   {-16.5, -4.5}, {-18, -6},     {-19.5, -6},
          {-19.5, -4.5}, {-21, -6},     {-22.5, -6},   {-22.5, -4.5},
          {-24, -6},     {-25.5, -6},   {-25.5, -4.5}}},

        // Cyclic polymers
        {"PEPTIDE1{A.Y.V.[Orn].L.[dF].P.F.[dF].N}$PEPTIDE1,PEPTIDE1,10:R2-1:R1$"
         "$$",
         {{2.30826, -0.75},
          {1.42658, -1.96353},
          {-4.45842e-16, -2.42705},
          {-1.42658, -1.96353},
          {-2.30826, -0.75},
          {-2.30826, 0.75},
          {-1.42658, 1.96353},
          {1.48614e-16, 2.42705},
          {1.42658, 1.96353},
          {2.30826, 0.75}}},

        {"PEPTIDE1{G.C.C.S.L.P.R.C.A.L.N.C}$PEPTIDE1,PEPTIDE1,2:R3-8:R3|"
         "PEPTIDE1,PEPTIDE1,3:R3-12:R3$$$",
         {{3.05739, 0.75},
          {1.55739, 0.75},
          {0.384644, 1.68523},
          {-1.07775, 1.35145},
          {-1.72857, 2.11689e-16},
          {-1.07775, -1.35145},
          {0.384644, -1.68523},
          {1.55739, -0.75},
          {3.05739, -0.75},
          {4.55739, -0.75},
          {6.05739, -0.75},
          {7.55739, -0.75}}},

        {"PEPTIDE1{C.K.G.K.G.A.K.C.S.R.L.M.Y.D.C.C.T.G.S.C.R.S.G.K.C}$PEPTIDE1,"
         "PEPTIDE1,1:R3-16:R3|PEPTIDE1,PEPTIDE1,8:R3-20:R3|PEPTIDE1,PEPTIDE1,"
         "15:R3-25:R3$$$",
         {{13.5429, -0.75},     {12.0429, -0.75},        {10.5429, -0.75},
          {9.04287, -0.75},     {7.54287, -0.75},        {6.04287, -0.75},
          {4.54287, -0.75},     {3.04287, -0.75},        {2.34578, -2.07818},
          {1.11131, -2.93028},  {-0.377754, -3.11109},   {-1.78028, -2.57918},
          {-2.77496, -1.45641}, {-3.13394, 3.83796e-16}, {-2.77496, 1.45641},
          {-1.78028, 2.57918},  {-0.377754, 3.11109},    {1.11131, 2.93028},
          {2.34578, 2.07818},   {3.04287, 0.75},         {4.54287, 0.75},
          {6.04287, 0.75},      {7.54287, 0.75},         {9.04287, 0.75},
          {10.5429, 0.75}}},

        {"PEPTIDE1{C.F.Y.S.W.G.N.Y.W.S.Y.Y.G.W.C.[am]}|PEPTIDE2{C.F.Y.S.W.G.N."
         "Y.W.S.Y.Y.G.W.C.[am]}|PEPTIDE3{C.W.N.Y.Y.W.G.Y.S.F.S.G.W.Y.C.G.[am]}$"
         "PEPTIDE1,PEPTIDE1,1:R3-15:R3|PEPTIDE1,PEPTIDE1,1:R1-16:R2|PEPTIDE1,"
         "PEPTIDE2,3:R1-8:R2|PEPTIDE2,PEPTIDE2,1:R3-15:R3|PEPTIDE2,PEPTIDE2,1:"
         "R1-16:R2|PEPTIDE2,PEPTIDE3,11:R3-14:R3|PEPTIDE3,PEPTIDE3,1:R3-15:R3|"
         "PEPTIDE3,PEPTIDE3,1:R1-17:R2$$$",
         {{3.52847, -0.75},     {2.91837, -2.12032},    {1.80365, -3.12401},
          {0.377066, -3.58754}, {-1.11472, -3.43075},   {-2.41376, -2.68075},
          {-3.29543, -1.46722}, {-3.6073, 4.41767e-16}, {-3.29543, 1.46722},
          {-2.41376, 2.68075},  {-1.11472, 3.43075},    {0.377066, 3.58754},
          {1.80365, 3.12401},   {2.91837, 2.12032},     {3.52847, 0.75},
          {5.02847, -0.75},     {8.93942, -9.42508},    {8.32932, -10.7954},
          {7.2146, -11.7991},   {5.78802, -12.2626},    {4.29623, -12.1058},
          {2.9972, -11.3558},   {2.11552, -10.1423},    {1.80365, -8.67508},
          {2.11552, -7.20786},  {2.9972, -5.99433},     {4.29623, -5.24433},
          {5.78802, -5.08754},  {7.2146, -5.55107},     {8.32932, -6.55476},
          {8.93942, -7.92508},  {10.4394, -9.42508},    {4.90634, -18.1002},
          {4.29623, -19.4705},  {3.18152, -20.4742},    {1.75493, -20.9377},
          {0.263149, -20.7809}, {-1.03589, -20.0309},   {-1.91757, -18.8174},
          {-2.22943, -17.3502}, {-1.91757, -15.8829},   {-1.03589, -14.6694},
          {0.263149, -13.9194}, {1.75493, -13.7626},    {3.18152, -14.2261},
          {4.29623, -15.2298},  {4.90634, -16.6002},    {7.90634, -18.1002},
          {6.40634, -18.1002}}},

        // CHEM polymers
        {"CHEM1{[SMCC]}|PEPTIDE1{L.M}|RNA1{R(C)P.R(A)P}$RNA1,PEPTIDE1,6:R2-1:"
         "R1|PEPTIDE1,CHEM1,2:R2-1:R1$$$",
         {{0, 0},
          {-1.5, -1.5},
          {0, -1.5},
          {-6, -3},
          {-6, -4.5},
          {-4.5, -3},
          {-3, -3},
          {-3, -4.5},
          {-1.5, -3}}},

        {"RNA1{R(A)P.R(A)P.R(G)P.R(G)P.R(C)P.R(U)P.R(A)P.R(A)P}|RNA2{R(A)P.R(A)"
         "P.R(G)P.R(G)P.R(C)P.R(U)P.R(A)P.R(A)P}|CHEM1{[sDBl]}$RNA2,CHEM1,24:"
         "R2-1:R3|RNA1,CHEM1,24:R2-1:R2$$$",
         {{0, 0},       {0, -1.5},    {1.5, 0},     {3, 0},       {3, -1.5},
          {4.5, 0},     {6, 0},       {6, -1.5},    {7.5, 0},     {9, 0},
          {9, -1.5},    {10.5, 0},    {12, 0},      {12, -1.5},   {13.5, 0},
          {15, 0},      {15, -1.5},   {16.5, 0},    {18, 0},      {18, -1.5},
          {19.5, 0},    {21, 0},      {21, -1.5},   {22.5, 0},    {0, -4.5},
          {0, -6},      {1.5, -4.5},  {3, -4.5},    {3, -6},      {4.5, -4.5},
          {6, -4.5},    {6, -6},      {7.5, -4.5},  {9, -4.5},    {9, -6},
          {10.5, -4.5}, {12, -4.5},   {12, -6},     {13.5, -4.5}, {15, -4.5},
          {15, -6},     {16.5, -4.5}, {18, -4.5},   {18, -6},     {19.5, -4.5},
          {21, -4.5},   {21, -6},     {22.5, -4.5}, {24, -2.25}}},

        {"RNA1{R(A)P.R(A)P.R(G)P.R(G)P.R(C)P.R(U)P.R(A)P.R(A)P}|RNA2{R(A)P.R(A)"
         "P.R(G)P.R(G)P.R(C)P.R(U)P.R(A)P.R(A)P}|CHEM1{[sDBl]}$RNA2,CHEM1,1:R2-"
         "1:R3|RNA1,CHEM1,1:R2-1:R2$$$",
         {{0, 0},       {0, -1.5},    {1.5, 0},     {3, 0},       {3, -1.5},
          {4.5, 0},     {6, 0},       {6, -1.5},    {7.5, 0},     {9, 0},
          {9, -1.5},    {10.5, 0},    {12, 0},      {12, -1.5},   {13.5, 0},
          {15, 0},      {15, -1.5},   {16.5, 0},    {18, 0},      {18, -1.5},
          {19.5, 0},    {21, 0},      {21, -1.5},   {22.5, 0},    {0, -4.5},
          {0, -6},      {1.5, -4.5},  {3, -4.5},    {3, -6},      {4.5, -4.5},
          {6, -4.5},    {6, -6},      {7.5, -4.5},  {9, -4.5},    {9, -6},
          {10.5, -4.5}, {12, -4.5},   {12, -6},     {13.5, -4.5}, {15, -4.5},
          {15, -6},     {16.5, -4.5}, {18, -4.5},   {18, -6},     {19.5, -4.5},
          {21, -4.5},   {21, -6},     {22.5, -4.5}, {-1.5, -2.25}}},

        {"RNA1{R(A)P.R(A)P.R(G)P.R(G)P.R(C)P.R(U)P.R(A)P.R(A)P}|RNA2{R(A)P.R(A)"
         "P.R(G)P.R(G)P.R(C)P.R(U)P.R(A)P.R(A)P}|CHEM1{[sDBl]}$RNA2,CHEM1,12:"
         "R2-1:R3|RNA1,CHEM1,12:R2-1:R2$$$",
         {{0, 0},       {0, -1.5},    {1.5, 0},     {3, 0},       {3, -1.5},
          {4.5, 0},     {6, 0},       {6, -1.5},    {7.5, 0},     {9, 0},
          {9, -1.5},    {10.5, 0},    {12, 0},      {12, -1.5},   {13.5, 0},
          {15, 0},      {15, -1.5},   {16.5, 0},    {18, 0},      {18, -1.5},
          {19.5, 0},    {21, 0},      {21, -1.5},   {22.5, 0},    {0, -4.5},
          {0, -6},      {1.5, -4.5},  {3, -4.5},    {3, -6},      {4.5, -4.5},
          {6, -4.5},    {6, -6},      {7.5, -4.5},  {9, -4.5},    {9, -6},
          {10.5, -4.5}, {12, -4.5},   {12, -6},     {13.5, -4.5}, {15, -4.5},
          {15, -6},     {16.5, -4.5}, {18, -4.5},   {18, -6},     {19.5, -4.5},
          {21, -4.5},   {21, -6},     {22.5, -4.5}, {10.5, -2.25}}},

        // Hairpin polymers
        {"RNA1{R(G)P.R(G)P.R(C)P.R(A)P.R(C)P.R(U)P.R(U)P.R(C)P.R(G)P.R(G)P.R(U)"
         "P.R(G)P.R(C)P.R(C)}$RNA1,RNA1,11:pair-32:pair|RNA1,RNA1,5:pair-38:"
         "pair|RNA1,RNA1,14:pair-29:pair|RNA1,RNA1,8:pair-35:pair|RNA1,RNA1,2:"
         "pair-41:pair$$$",
         {{-14.3458, 2.07818},  {-14.3458, 0.578184},  {-12.8458, 2.07818},
          {-11.3458, 2.07818},  {-11.3458, 0.578184},  {-9.84578, 2.07818},
          {-8.34578, 2.07818},  {-8.34578, 0.578184},  {-6.84578, 2.07818},
          {-5.34578, 2.07818},  {-5.34578, 0.578184},  {-3.84578, 2.07818},
          {-2.34578, 2.07818},  {-2.34578, 0.578184},  {-1.11131, 2.93028},
          {0.377754, 3.11109},  {0.558559, 4.60015},   {1.78028, 2.57918},
          {2.77496, 1.45641},   {4.10315, 2.1535},     {3.13394, 3.83796e-16},
          {2.77496, -1.45641},  {4.10315, -2.1535},    {1.78028, -2.57918},
          {0.377754, -3.11109}, {0.558559, -4.60015},  {-1.11131, -2.93028},
          {-2.34578, -2.07818}, {-2.34578, -0.578184}, {-3.84578, -2.07818},
          {-5.34578, -2.07818}, {-5.34578, -0.578184}, {-6.84578, -2.07818},
          {-8.34578, -2.07818}, {-8.34578, -0.578184}, {-9.84578, -2.07818},
          {-11.3458, -2.07818}, {-11.3458, -0.578184}, {-12.8458, -2.07818},
          {-14.3458, -2.07818}, {-14.3458, -0.578184}}},

        {"RNA1{R(G)P.R(G)P.R(C)P.R(A)P.R(C)P.R(U)P.R(G)P.R(G)P.R(U)P.R(G)P.R(C)"
         "P.R(C)}$RNA1,RNA1,11:pair-26:pair|RNA1,RNA1,5:pair-32:pair|RNA1,RNA1,"
         "14:pair-23:pair|RNA1,RNA1,8:pair-29:pair|RNA1,RNA1,2:pair-35:pair$$$",
         {{-12.3789, 2.635},   {-12.3789, 1.135},   {-10.8789, 2.635},
          {-9.37886, 2.635},   {-9.37886, 1.135},   {-7.87886, 2.635},
          {-6.37886, 2.635},   {-6.37886, 1.135},   {-4.87886, 2.635},
          {-3.37886, 2.635},   {-3.37886, 1.135},   {-1.87886, 2.635},
          {-0.378856, 2.635},  {-0.378856, 1.135},  {1.10588, 2.42153},
          {2.2395, 1.43924},   {3.50138, 2.2502},   {2.6621, 3.26013e-16},
          {2.2395, -1.43924},  {3.50138, -2.2502},  {1.10588, -2.42153},
          {-0.378856, -2.635}, {-0.378856, -1.135}, {-1.87886, -2.635},
          {-3.37886, -2.635},  {-3.37886, -1.135},  {-4.87886, -2.635},
          {-6.37886, -2.635},  {-6.37886, -1.135},  {-7.87886, -2.635},
          {-9.37886, -2.635},  {-9.37886, -1.135},  {-10.8789, -2.635},
          {-12.3789, -2.635},  {-12.3789, -1.135}}}}),
    test_data)
{
    std::string helm = test_data.first;
    coords_t monomer_coords = test_data.second;
    auto mol = helm::helm_to_rdkit(helm);
    schrodinger::rdkit_extensions::compute_monomer_mol_coords(*mol);

    auto& conformer = mol->getConformer();
    bool failed = false;
    std::string expected_str = "{";
    std::string actual_str = "{";

    // Helper to convert double to string without unnecessary trailing zeros
    auto fmt = [](double x) -> std::string {
        std::ostringstream oss;
        oss << std::fixed << std::setprecision(6) << x;
        std::string s = oss.str();
        // Remove trailing zeros
        s.erase(s.find_last_not_of('0') + 1, std::string::npos);
        if (!s.empty() && s.back() == '.')
            s.pop_back(); // remove trailing dot
        return s;
    };

    for (auto monomer : mol->atoms()) {
        auto monomer_idx = monomer->getIdx();
        if (monomer_idx >= monomer_coords.size()) {
            failed = true;
            BOOST_FAIL("Monomer has "
                       << mol->getNumAtoms() << " atoms, but only "
                       << monomer_coords.size() << " sets of expected coords");
            break;
        }
        auto expected_coords = monomer_coords[monomer_idx];
        auto actual_coords = conformer.getAtomPos(monomer_idx);

        expected_str += "{" + fmt(expected_coords[0]) + ", " +
                        fmt(expected_coords[1]) + "}, ";
        actual_str +=
            "{" + fmt(actual_coords[0]) + ", " + fmt(actual_coords[1]) + "}, ";

        if (std::abs(expected_coords[0] - actual_coords[0]) >= 0.01 ||
            std::abs(expected_coords[1] - actual_coords[1]) >= 0.01) {
            failed = true;
        }
    }

    // Remove trailing comma and space
    if (expected_str.size() > 2)
        expected_str.pop_back(), expected_str.pop_back();
    if (actual_str.size() > 2)
        actual_str.pop_back(), actual_str.pop_back();
    expected_str += "}";
    actual_str += "}";

    BOOST_CHECK_MESSAGE(!failed, "Mismatch for HELM: "
                                     << helm
                                     << "\nExpected coords: " << expected_str
                                     << "\nComputed coords: " << actual_str);
}
